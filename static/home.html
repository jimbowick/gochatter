<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat Example</title>
    <script type="text/javascript">
        window.onload = function () {
            var username = "default userio";
            var currentRoom = "main room";
            var conn;
            var msg = document.getElementById("msg");
            var log = document.getElementById("log");
            document.getElementById("currentroomName").innerHTML = currentRoom;
            if (window["WebSocket"]) {
                conn = new WebSocket("ws://" + document.location.host + "/ws?name=" + username);
                conn.onclose = function (evt) {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Connection closed.</b>";
                    appendLog(item);
                };
                conn.onmessage = function (evt) {
                    var item = document.createElement("div");
                    var obm = JSON.parse(evt.data);
                    if (obm["Messagetype"] == "chat" && obm["Inroom"] == currentRoom) {
                        item.innerText = obm["Payload"];
                        appendLog(item);
                    } else if (obm["Messagetype"] == "users") {
                        refreshUsers(obm["Payload"])
                    } else if (obm["Messagetype"] == "chatrooms") {
                        refreshRooms(obm["Payload"])
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }


            document.getElementById("setunamebutton").onclick = function () {
                username = document.getElementById("unamefield").value;
                var finmess = JSON.stringify({Messagetype: "setName", Payload: username});
                conn.send(finmess)
            }
            document.getElementById("addroom").onclick = function () {
                newroomValue = document.getElementById("newroomName").value;
                var finmess = JSON.stringify({Messagetype: "roomname", Payload: newroomValue});
                conn.send(finmess)
            }

            function refreshRooms(rooms) {
                document.getElementById("chatRooms").innerHTML = "";
                rooms.forEach(function (str) {
                    var listitem = document.createElement("li");
                    var but = document.createElement("button");
                    but.innerHTML = str
                    but.onclick = function(){
                        currentRoom = str
                    };
                    listitem.appendChild(but);
                    document.getElementById("chatRooms").appendChild(listitem)
                });
            }
            function refreshUsers(users) {
                document.getElementById("unamelist").innerHTML = "";
                users.forEach(function (str) {
                    var listitem = document.createElement("li");
                    listitem.innerHTML = str;
                    document.getElementById("unamelist").appendChild(listitem)
                });
            }

            function appendLog(item) {
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }
            document.getElementById("form").onsubmit = function () {
                if (!conn) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                var messy = msg.value;
                var finmess = JSON.stringify({Messagetype: "chat", Payload: messy, Inroom: currentRoom});
                conn.send(finmess);
                msg.value = "";
                return false;
            };
        };
    </script>
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }

        .bodyCont {
            display: block;
            height: 1000px;
            width: 1000px;
            display: block;
            /*position: fixed;*/
            overflow: hidden;
            background: gray;
        }

        #currentroomName {
            box-sizing: border-box;
            padding-top: 10px;
            text-align: center;
            position: absolute;
            left: 49px;
            top: 410px;
            background-color: white;
            height: 40px;
            width: 200px;
        }

        #log {
            min-width: 500px;
            max-width: 500px;
            max-height: 500px;
            min-height: 300px;
            background: white;
            /*margin: 5em;*/
            /*padding: 0.5em 0.5em 0.5em 0.5em;*/
            position: absolute;
            top: 100px;
            left: 49px;
            overflow: auto;
        }

        #unamelist {
            min-width: 200px;
            max-width: 200px;
            max-height: 250px;
            min-height: 250px;
            background: white;
            position: absolute;
            top: 100px;
            left: 550px;
            overflow: auto;
        }

        #form {
            display: block;
            position: absolute;
            /*left: 210px;*/
            /*top: 50px;*/
            max-width: 50%;
            min-width: 50%;

        }

        #msg {
            position: absolute;
            left: 112px;
            top: 50px;

        }

        #newroomName {
            position: absolute;
            top: 27px;
            left: 3px;
        }

        #unamefield {
            position: absolute;
            display: block;
            top: 75px;
            left: 112px;
        }

        .unameContainer {
            /*left: 210px;*/
            /*top: 20px;*/
            /*position: absolute;*/
            max-width: 50%;
            min-width: 50%;

        }

        #allbuttons {
            display: block;
            position: absolute;
            width: 100%;

        }

        #addroom {
            left: 3px;
            top: 5px;
            position: absolute;
            width: 100px;
            text-align: center;
        }

        #setunamebutton {
            left: 3px;
            top: 75px;
            position: absolute;
            width: 100px;
            text-align: center;
        }

        #sendButton {
            left: 3px;
            top: 50px;
            position: absolute;
            width: 100px;
            text-align: center;
        }

        #startWebsock {
            width: 100px;
            padding: 2px;
            position: absolute;
            top: 4px;
            left: 255px;
        }

        #chatRooms {
            text-align: center;
            min-width: 200px;
            min-height: 100px;
            max-height: 100px;
            list-style: none;
            background-color: white;
            position: absolute;
            left: 550px;
            top: 352px;
            overflow: auto;
        }

        #chatRooms li a {
            text-decoration: none;
            padding: 5px 30px 5px 10px;
            display: block;
        }
    </style>
</head>

<body>
<div class="bodyCont">
    <div id="log"></div>
    <div id="currentroomName"></div>
    <ul id="unamelist"></ul>
    <button id="addroom">add chat room</button>
    <input type="text" id="newroomName">
    <ul id="chatRooms">
        <li id="firstRoom">
            <a href="#">General Chat</a>
        </li>
        <li id="secondRoom">
            <a href="#">Buy and Sell</a>
        </li>
    </ul>
    <div id="allbuttons">
        <form id="form">
            <input aria-label="Send" type="submit" value="Send" id="sendButton"/>
            <input aria-label="Message Field" type="text" id="msg" size="64"/>
        </form>

        <div class="unameContainer">
            <button id="setunamebutton">Set Name</button>

            <input title="username field" type="text" id="unamefield" size="64"/>
        </div>
    </div>
    <button id="startWebsock">Start Web Socket</button>

</div>
</body>

</html>